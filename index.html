<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Gemini TTS éŸ³å£°ç”Ÿæˆ</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 2em; background: #f7f7f7; }
    textarea, input { width: 100%; padding: 10px; margin-top: 1em; box-sizing: border-box; }
    button { margin-top: 1em; padding: 10px; font-size: 16px; background-color: #2196F3; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #1976D2; }
    audio { margin-top: 20px; width: 100%; }
  </style>
</head>
<body>
  <h1>ğŸ§ Gemini TTS éŸ³å£°ç”Ÿæˆ (HTMLå˜ä½“ç‰ˆ)</h1>
  <p>ãƒ©ã‚¸ã‚ªå°æœ¬ã‚„æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ã€Geminiã§éŸ³å£°(mp3)ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
  <textarea id="text">ä½ å¥½ï¼æ¬¢è¿æ”¶å¬ä¸­æ–‡èŠ‚ç›®ï¼</textarea>
  <input type="text" id="apiKey" placeholder="Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
  <button onclick="generateAudio()">ğŸ¤ éŸ³å£°ã‚’ç”Ÿæˆ</button>
  <div id="status"></div>
  <audio id="player" controls style="display:none;"></audio>

  <script>
    async function generateAudio() {
      const text = document.getElementById('text').value;
      const apiKey = document.getElementById('apiKey').value.trim();
      const status = document.getElementById('status');
      const player = document.getElementById('player');
      status.textContent = "â³ ç”Ÿæˆä¸­...";

      const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro-preview-tts:streamGenerateContent?key=' + encodeURIComponent(apiKey);
      const body = {
        contents: [
          {
            role: "user",
            parts: [{ text }]
          }
        ],
        generationConfig: {
          responseModalities: ["audio"],
          temperature: 1,
          speech_config: {
            voice_config: {
              prebuilt_voice_config: {
                voice_name: "Zephyr"
              }
            }
          }
        }
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const reader = response.body.getReader();
        let result = '';
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          result += decoder.decode(value);
        }

        // ã™ã¹ã¦ã® chunk ã‚’è§£æã—ã¦ base64 éŸ³å£°ã‚’å–ã‚Šå‡ºã™
        const lines = result.trim().split('\n');
        for (const line of lines) {
          if (line.trim() === '') continue;
          const json = JSON.parse(line);
          const data = json?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
          const mime = json?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

          if (data && mime) {
            const audioBlob = new Blob([Uint8Array.from(atob(data), c => c.charCodeAt(0))], { type: mime });
            const audioUrl = URL.createObjectURL(audioBlob);
            player.src = audioUrl;
            player.style.display = "block";
            status.innerHTML = "âœ… éŸ³å£°ç”Ÿæˆå®Œäº†ï¼<br>â†“ ä¸‹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰å†ç”Ÿã§ãã¾ã™ã€‚";
            return;
          }
        }

        status.textContent = "âš ï¸ éŸ³å£°ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      } catch (err) {
        console.error(err);
        status.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message;
      }
    }
  </script>
</body>
</html>
